#!/usr/bin/env bash
# Configure /etc/hosts so localhost -> 127.0.0.2 and facebook.com -> 8.8.8.8

set -euo pipefail

if [ "${EUID:-$(id -u)}" -ne 0 ]; then
  printf '%s\n' "This script must be run as root (try: sudo $0)" >&2
  exit 1
fi

HOSTS_FILE="/etc/hosts"
BACKUP="/etc/hosts.backup.$(date +%Y%m%d-%H%M%S)"
TMP="$(mktemp)"

cp -p -- "$HOSTS_FILE" "$BACKUP"

awk '
  BEGIN { replaced_localhost = 0 }
  /^[[:space:]]*#/ || /^[[:space:]]*$/ { print; next }
  {
    # Drop any existing facebook.com mapping
    if (match($0, /(^|[[:space:]])facebook\.com([[:space:]]|$)/)) next

    # Replace first IPv4 line that includes a bare "localhost"
    if (!replaced_localhost &&
        match($0, /^[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+[[:space:]].*$/) &&
        match($0, /(^|[[:space:]])localhost([[:space:]]|$)/)) {
      print "127.0.0.2 localhost"
      replaced_localhost = 1
      next
    }
    print
  }
' -- "$HOSTS_FILE" > "$TMP"

if ! grep -Eq '^[[:space:]]*127\.0\.0\.2[[:space:]]+localhost([[:space:]]|$)' "$TMP"; then
  printf '%s\n' "127.0.0.2 localhost" >> "$TMP"
fi

printf '%s\n' "8.8.8.8 facebook.com" >> "$TMP"

install -m 644 -o root -g root -- "$TMP" "$HOSTS_FILE"
rm -f -- "$TMP"


grep -E '(^|\s)(localhost|facebook\.com)(\s|$)' "$HOSTS_FILE" || true
